FROM n8nio/n8n:latest

USER root

RUN apk add --no-cache sed grep

# Apply Business plan patches - Most enterprise features enabled
RUN sed -i 's/sharing: this\.license\.isSharingEnabled(),/sharing: true,/g' /usr/local/lib/node_modules/n8n/dist/services/frontend.service.js && \
    sed -i 's/logStreaming: this\.license\.isLogStreamingEnabled(),/logStreaming: false,/g' /usr/local/lib/node_modules/n8n/dist/services/frontend.service.js && \
    sed -i 's/ldap: this\.license\.isLdapEnabled(),/ldap: true,/g' /usr/local/lib/node_modules/n8n/dist/services/frontend.service.js && \
    sed -i 's/saml: this\.license\.isSamlEnabled(),/saml: true,/g' /usr/local/lib/node_modules/n8n/dist/services/frontend.service.js && \
    sed -i 's/oidc: this\.licenseState\.isOidcLicensed(),/oidc: true,/g' /usr/local/lib/node_modules/n8n/dist/services/frontend.service.js && \
    sed -i 's/mfaEnforcement: this\.licenseState\.isMFAEnforcementLicensed(),/mfaEnforcement: true,/g' /usr/local/lib/node_modules/n8n/dist/services/frontend.service.js && \
    sed -i 's/advancedExecutionFilters: this\.license\.isAdvancedExecutionFiltersEnabled(),/advancedExecutionFilters: true,/g' /usr/local/lib/node_modules/n8n/dist/services/frontend.service.js && \
    sed -i 's/variables: this\.license\.isVariablesEnabled(),/variables: true,/g' /usr/local/lib/node_modules/n8n/dist/services/frontend.service.js && \
    sed -i 's/sourceControl: this\.license\.isSourceControlLicensed(),/sourceControl: true,/g' /usr/local/lib/node_modules/n8n/dist/services/frontend.service.js && \
    sed -i 's/auditLogs: this\.license\.isAuditLogsLicensed(),/auditLogs: false,/g' /usr/local/lib/node_modules/n8n/dist/services/frontend.service.js && \
    sed -i 's/externalSecrets: this\.license\.isExternalSecretsEnabled(),/externalSecrets: false,/g' /usr/local/lib/node_modules/n8n/dist/services/frontend.service.js && \
    sed -i 's/debugInEditor: this\.license\.isDebugInEditorLicensed(),/debugInEditor: true,/g' /usr/local/lib/node_modules/n8n/dist/services/frontend.service.js && \
    sed -i 's/workerView: this\.license\.isWorkerViewLicensed(),/workerView: false,/g' /usr/local/lib/node_modules/n8n/dist/services/frontend.service.js && \
    sed -i 's/advancedPermissions: this\.license\.isAdvancedPermissionsLicensed(),/advancedPermissions: true,/g' /usr/local/lib/node_modules/n8n/dist/services/frontend.service.js && \
    sed -i 's/apiKeyScopes: this\.license\.isApiKeyScopesEnabled(),/apiKeyScopes: true,/g' /usr/local/lib/node_modules/n8n/dist/services/frontend.service.js && \
    sed -i 's/workflowDiffs: this\.licenseState\.isWorkflowDiffsLicensed(),/workflowDiffs: true,/g' /usr/local/lib/node_modules/n8n/dist/services/frontend.service.js && \
    sed -i 's/apiDisabled: this\.license\.isAPIDisabled(),/apiDisabled: false,/g' /usr/local/lib/node_modules/n8n/dist/services/frontend.service.js && \
    sed -i 's/showNonProdBanner: this\.license\.isShowNonProdBannerLicensed(),/showNonProdBanner: false,/g' /usr/local/lib/node_modules/n8n/dist/services/frontend.service.js && \
    sed -i 's/workflowHistory: this\.license\.isWorkflowHistoryLicensed(),/workflowHistory: true,/g' /usr/local/lib/node_modules/n8n/dist/services/frontend.service.js && \
    sed -i 's/binaryDataS3: this\.license\.isBinaryDataS3Licensed(),/binaryDataS3: true,/g' /usr/local/lib/node_modules/n8n/dist/services/frontend.service.js && \
    sed -i 's/multipleMainInstances: this\.license\.isMultipleMainInstancesLicensed(),/multipleMainInstances: true,/g' /usr/local/lib/node_modules/n8n/dist/services/frontend.service.js && \
    sed -i 's/aiAssistant: this\.license\.isAiAssistantLicensed(),/aiAssistant: false,/g' /usr/local/lib/node_modules/n8n/dist/services/frontend.service.js && \
    sed -i 's/askAi: this\.license\.isAskAiLicensed(),/askAi: false,/g' /usr/local/lib/node_modules/n8n/dist/services/frontend.service.js && \
    sed -i 's/communityNodesCustomRegistry: this\.license\.isCommunityNodesCustomRegistryLicensed(),/communityNodesCustomRegistry: false,/g' /usr/local/lib/node_modules/n8n/dist/services/frontend.service.js && \
    sed -i 's/aiCredits: this\.license\.isAiCreditsLicensed(),/aiCredits: false,/g' /usr/local/lib/node_modules/n8n/dist/services/frontend.service.js && \
    sed -i 's/folders: this\.license\.isFoldersLicensed(),/folders: true,/g' /usr/local/lib/node_modules/n8n/dist/services/frontend.service.js && \
    sed -i 's/customRoles: this\.license\.isCustomRolesLicensed(),/customRoles: true,/g' /usr/local/lib/node_modules/n8n/dist/services/frontend.service.js && \
    sed -i 's/projectRoleAdmin: this\.license\.isProjectRoleAdminLicensed(),/projectRoleAdmin: true,/g' /usr/local/lib/node_modules/n8n/dist/services/frontend.service.js && \
    sed -i 's/projectRoleEditor: this\.license\.isProjectRoleEditorLicensed(),/projectRoleEditor: true,/g' /usr/local/lib/node_modules/n8n/dist/services/frontend.service.js && \
    sed -i 's/projectRoleViewer: this\.license\.isProjectRoleViewerLicensed(),/projectRoleViewer: true,/g' /usr/local/lib/node_modules/n8n/dist/services/frontend.service.js && \
    sed -i 's/insightsViewSummary: this\.license\.isInsightsViewSummaryLicensed(),/insightsViewSummary: true,/g' /usr/local/lib/node_modules/n8n/dist/services/frontend.service.js && \
    sed -i 's/insightsViewDashboard: this\.license\.isInsightsViewDashboardLicensed(),/insightsViewDashboard: true,/g' /usr/local/lib/node_modules/n8n/dist/services/frontend.service.js && \
    sed -i 's/insightsViewHourlyData: this\.license\.isInsightsViewHourlyDataLicensed(),/insightsViewHourlyData: false,/g' /usr/local/lib/node_modules/n8n/dist/services/frontend.service.js

# Set Business plan quotas (40k executions, 6 projects, 30 days insights)
RUN find /usr/local/lib/node_modules/n8n/dist -name "*license*" -type f | while read file; do \
        sed -i 's/getValue.*quota.*activeWorkflows.*/getValue(quota) { return 6; }/g' "$file"; \
        sed -i 's/getValue.*quota.*maxVariables.*/getValue(quota) { return 50; }/g' "$file"; \
        sed -i 's/getValue.*quota.*users.*/getValue(quota) { return -1; }/g' "$file"; \
        sed -i 's/getValue.*quota.*workflowHistoryPrune.*/getValue(quota) { return 30; }/g' "$file"; \
        sed -i 's/getValue.*quota.*maxTeamProjects.*/getValue(quota) { return 6; }/g' "$file"; \
        sed -i 's/getValue.*quota.*aiCredits.*/getValue(quota) { return 0; }/g' "$file"; \
        sed -i 's/getValue.*quota.*insights.*/getValue(quota) { return 30; }/g' "$file"; \
        sed -i 's/getValue.*quota.*evaluations.*/getValue(quota) { return 0; }/g' "$file"; \
    done || true

# Set plan name to Business
RUN find /usr/local/lib/node_modules/n8n/dist -name "*license*" -type f | while read file; do \
        sed -i 's/getPlanName.*{.*return.*}/getPlanName() { return "Business"; }/g' "$file"; \
        sed -i 's/getConsumerId.*{.*return.*}/getConsumerId() { return "business-free"; }/g' "$file"; \
    done || true

# Set environment variables to disable license checks
ENV N8N_LICENSE_SERVER_URL=""
ENV N8N_LICENSE_SERVER_URL_TRIAL=""
ENV N8N_LICENSE_SERVER_URL_TRIAL_ACTIVATION=""
ENV N8N_LICENSE_SERVER_URL_TRIAL_ACTIVATION_RETRY=""

# Enable source control for Business plan
ENV N8N_SOURCE_CONTROL_DISABLED="false"
ENV N8N_SOURCE_CONTROL_CONNECTED="true"
ENV N8N_SOURCE_CONTROL_REPOSITORY_URL="https://github.com/sagebeme/n8n.git"
ENV N8N_SOURCE_CONTROL_REPOSITORY_BRANCH="master"

# Set execution limits for Business plan
ENV N8N_EXECUTIONS_MODE="regular"

# Switch back to node user
USER node

# Expose port
EXPOSE 5678

# Use the exact same configuration as the base image
ENTRYPOINT ["tini", "--", "/docker-entrypoint.sh"]
CMD []
