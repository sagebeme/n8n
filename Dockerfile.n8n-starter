FROM n8nio/n8n:latest

USER root

RUN apk add --no-cache sed grep

# Apply Starter plan patches - Basic features only
RUN sed -i 's/sharing: this\.license\.isSharingEnabled(),/sharing: false,/g' /usr/local/lib/node_modules/n8n/dist/services/frontend.service.js && \
    sed -i 's/logStreaming: this\.license\.isLogStreamingEnabled(),/logStreaming: false,/g' /usr/local/lib/node_modules/n8n/dist/services/frontend.service.js && \
    sed -i 's/ldap: this\.license\.isLdapEnabled(),/ldap: false,/g' /usr/local/lib/node_modules/n8n/dist/services/frontend.service.js && \
    sed -i 's/saml: this\.license\.isSamlEnabled(),/saml: false,/g' /usr/local/lib/node_modules/n8n/dist/services/frontend.service.js && \
    sed -i 's/oidc: this\.licenseState\.isOidcLicensed(),/oidc: false,/g' /usr/local/lib/node_modules/n8n/dist/services/frontend.service.js && \
    sed -i 's/mfaEnforcement: this\.licenseState\.isMFAEnforcementLicensed(),/mfaEnforcement: false,/g' /usr/local/lib/node_modules/n8n/dist/services/frontend.service.js && \
    sed -i 's/advancedExecutionFilters: this\.license\.isAdvancedExecutionFiltersEnabled(),/advancedExecutionFilters: false,/g' /usr/local/lib/node_modules/n8n/dist/services/frontend.service.js && \
    sed -i 's/variables: this\.license\.isVariablesEnabled(),/variables: false,/g' /usr/local/lib/node_modules/n8n/dist/services/frontend.service.js && \
    sed -i 's/sourceControl: this\.license\.isSourceControlLicensed(),/sourceControl: false,/g' /usr/local/lib/node_modules/n8n/dist/services/frontend.service.js && \
    sed -i 's/auditLogs: this\.license\.isAuditLogsLicensed(),/auditLogs: false,/g' /usr/local/lib/node_modules/n8n/dist/services/frontend.service.js && \
    sed -i 's/externalSecrets: this\.license\.isExternalSecretsEnabled(),/externalSecrets: false,/g' /usr/local/lib/node_modules/n8n/dist/services/frontend.service.js && \
    sed -i 's/debugInEditor: this\.license\.isDebugInEditorLicensed(),/debugInEditor: false,/g' /usr/local/lib/node_modules/n8n/dist/services/frontend.service.js && \
    sed -i 's/workerView: this\.license\.isWorkerViewLicensed(),/workerView: false,/g' /usr/local/lib/node_modules/n8n/dist/services/frontend.service.js && \
    sed -i 's/advancedPermissions: this\.license\.isAdvancedPermissionsLicensed(),/advancedPermissions: false,/g' /usr/local/lib/node_modules/n8n/dist/services/frontend.service.js && \
    sed -i 's/apiKeyScopes: this\.license\.isApiKeyScopesEnabled(),/apiKeyScopes: false,/g' /usr/local/lib/node_modules/n8n/dist/services/frontend.service.js && \
    sed -i 's/workflowDiffs: this\.licenseState\.isWorkflowDiffsLicensed(),/workflowDiffs: false,/g' /usr/local/lib/node_modules/n8n/dist/services/frontend.service.js && \
    sed -i 's/apiDisabled: this\.license\.isAPIDisabled(),/apiDisabled: false,/g' /usr/local/lib/node_modules/n8n/dist/services/frontend.service.js && \
    sed -i 's/showNonProdBanner: this\.license\.isShowNonProdBannerLicensed(),/showNonProdBanner: false,/g' /usr/local/lib/node_modules/n8n/dist/services/frontend.service.js && \
    sed -i 's/workflowHistory: this\.license\.isWorkflowHistoryLicensed(),/workflowHistory: false,/g' /usr/local/lib/node_modules/n8n/dist/services/frontend.service.js && \
    sed -i 's/binaryDataS3: this\.license\.isBinaryDataS3Licensed(),/binaryDataS3: false,/g' /usr/local/lib/node_modules/n8n/dist/services/frontend.service.js && \
    sed -i 's/multipleMainInstances: this\.license\.isMultipleMainInstancesLicensed(),/multipleMainInstances: false,/g' /usr/local/lib/node_modules/n8n/dist/services/frontend.service.js && \
    sed -i 's/aiAssistant: this\.license\.isAiAssistantLicensed(),/aiAssistant: false,/g' /usr/local/lib/node_modules/n8n/dist/services/frontend.service.js && \
    sed -i 's/askAi: this\.license\.isAskAiLicensed(),/askAi: false,/g' /usr/local/lib/node_modules/n8n/dist/services/frontend.service.js && \
    sed -i 's/communityNodesCustomRegistry: this\.license\.isCommunityNodesCustomRegistryLicensed(),/communityNodesCustomRegistry: false,/g' /usr/local/lib/node_modules/n8n/dist/services/frontend.service.js && \
    sed -i 's/aiCredits: this\.license\.isAiCreditsLicensed(),/aiCredits: false,/g' /usr/local/lib/node_modules/n8n/dist/services/frontend.service.js && \
    sed -i 's/folders: this\.license\.isFoldersLicensed(),/folders: false,/g' /usr/local/lib/node_modules/n8n/dist/services/frontend.service.js && \
    sed -i 's/customRoles: this\.license\.isCustomRolesLicensed(),/customRoles: false,/g' /usr/local/lib/node_modules/n8n/dist/services/frontend.service.js && \
    sed -i 's/projectRoleAdmin: this\.license\.isProjectRoleAdminLicensed(),/projectRoleAdmin: false,/g' /usr/local/lib/node_modules/n8n/dist/services/frontend.service.js && \
    sed -i 's/projectRoleEditor: this\.license\.isProjectRoleEditorLicensed(),/projectRoleEditor: false,/g' /usr/local/lib/node_modules/n8n/dist/services/frontend.service.js && \
    sed -i 's/projectRoleViewer: this\.license\.isProjectRoleViewerLicensed(),/projectRoleViewer: false,/g' /usr/local/lib/node_modules/n8n/dist/services/frontend.service.js && \
    sed -i 's/insightsViewSummary: this\.license\.isInsightsViewSummaryLicensed(),/insightsViewSummary: false,/g' /usr/local/lib/node_modules/n8n/dist/services/frontend.service.js && \
    sed -i 's/insightsViewDashboard: this\.license\.isInsightsViewDashboardLicensed(),/insightsViewDashboard: false,/g' /usr/local/lib/node_modules/n8n/dist/services/frontend.service.js && \
    sed -i 's/insightsViewHourlyData: this\.license\.isInsightsViewHourlyDataLicensed(),/insightsViewHourlyData: false,/g' /usr/local/lib/node_modules/n8n/dist/services/frontend.service.js

# Set Starter plan quotas (2.5k executions, 5 concurrent, 1 project)
RUN find /usr/local/lib/node_modules/n8n/dist -name "*license*" -type f | while read file; do \
        sed -i 's/getValue.*quota.*activeWorkflows.*/getValue(quota) { return 1; }/g' "$file"; \
        sed -i 's/getValue.*quota.*maxVariables.*/getValue(quota) { return 0; }/g' "$file"; \
        sed -i 's/getValue.*quota.*users.*/getValue(quota) { return -1; }/g' "$file"; \
        sed -i 's/getValue.*quota.*workflowHistoryPrune.*/getValue(quota) { return 0; }/g' "$file"; \
        sed -i 's/getValue.*quota.*maxTeamProjects.*/getValue(quota) { return 1; }/g' "$file"; \
        sed -i 's/getValue.*quota.*aiCredits.*/getValue(quota) { return 0; }/g' "$file"; \
        sed -i 's/getValue.*quota.*insights.*/getValue(quota) { return 0; }/g' "$file"; \
        sed -i 's/getValue.*quota.*evaluations.*/getValue(quota) { return 0; }/g' "$file"; \
    done || true

# Set plan name to Starter
RUN find /usr/local/lib/node_modules/n8n/dist -name "*license*" -type f | while read file; do \
        sed -i 's/getPlanName.*{.*return.*}/getPlanName() { return "Starter"; }/g' "$file"; \
        sed -i 's/getConsumerId.*{.*return.*}/getConsumerId() { return "starter-free"; }/g' "$file"; \
    done || true

# Set environment variables to disable license checks
ENV N8N_LICENSE_SERVER_URL=""
ENV N8N_LICENSE_SERVER_URL_TRIAL=""
ENV N8N_LICENSE_SERVER_URL_TRIAL_ACTIVATION=""
ENV N8N_LICENSE_SERVER_URL_TRIAL_ACTIVATION_RETRY=""

# Disable source control to prevent connection errors
ENV N8N_SOURCE_CONTROL_DISABLED="true"
ENV N8N_SOURCE_CONTROL_CONNECTED="false"

# Set execution limits for Starter plan
ENV N8N_EXECUTIONS_MODE="regular"
ENV N8N_CONCURRENT_EXECUTIONS="5"

# Switch back to node user
USER node

# Expose port
EXPOSE 5678

# Use the exact same configuration as the base image
ENTRYPOINT ["tini", "--", "/docker-entrypoint.sh"]
CMD []
