FROM n8nio/n8n:latest

# Switch to root to apply patches
USER root

# Install sed and grep for verification
RUN apk add --no-cache sed grep

# Apply comprehensive enterprise features patch
RUN sed -i 's/sharing: this\.license\.isSharingEnabled(),/sharing: true,/g' /usr/local/lib/node_modules/n8n/dist/services/frontend.service.js && \
    sed -i 's/logStreaming: this\.license\.isLogStreamingEnabled(),/logStreaming: true,/g' /usr/local/lib/node_modules/n8n/dist/services/frontend.service.js && \
    sed -i 's/ldap: this\.license\.isLdapEnabled(),/ldap: true,/g' /usr/local/lib/node_modules/n8n/dist/services/frontend.service.js && \
    sed -i 's/saml: this\.license\.isSamlEnabled(),/saml: true,/g' /usr/local/lib/node_modules/n8n/dist/services/frontend.service.js && \
    sed -i 's/oidc: this\.licenseState\.isOidcLicensed(),/oidc: true,/g' /usr/local/lib/node_modules/n8n/dist/services/frontend.service.js && \
    sed -i 's/mfaEnforcement: this\.licenseState\.isMFAEnforcementLicensed(),/mfaEnforcement: true,/g' /usr/local/lib/node_modules/n8n/dist/services/frontend.service.js && \
    sed -i 's/advancedExecutionFilters: this\.license\.isAdvancedExecutionFiltersEnabled(),/advancedExecutionFilters: true,/g' /usr/local/lib/node_modules/n8n/dist/services/frontend.service.js && \
    sed -i 's/variables: this\.license\.isVariablesEnabled(),/variables: true,/g' /usr/local/lib/node_modules/n8n/dist/services/frontend.service.js && \
    sed -i 's/sourceControl: this\.license\.isSourceControlLicensed(),/sourceControl: true,/g' /usr/local/lib/node_modules/n8n/dist/services/frontend.service.js && \
    sed -i 's/externalSecrets: this\.license\.isExternalSecretsEnabled(),/externalSecrets: true,/g' /usr/local/lib/node_modules/n8n/dist/services/frontend.service.js && \
    sed -i 's/debugInEditor: this\.license\.isDebugInEditorLicensed(),/debugInEditor: true,/g' /usr/local/lib/node_modules/n8n/dist/services/frontend.service.js && \
    sed -i 's/workerView: this\.license\.isWorkerViewLicensed(),/workerView: true,/g' /usr/local/lib/node_modules/n8n/dist/services/frontend.service.js && \
    sed -i 's/advancedPermissions: this\.license\.isAdvancedPermissionsLicensed(),/advancedPermissions: true,/g' /usr/local/lib/node_modules/n8n/dist/services/frontend.service.js && \
    sed -i 's/apiKeyScopes: this\.license\.isApiKeyScopesEnabled(),/apiKeyScopes: true,/g' /usr/local/lib/node_modules/n8n/dist/services/frontend.service.js && \
    sed -i 's/workflowDiffs: this\.licenseState\.isWorkflowDiffsLicensed(),/workflowDiffs: true,/g' /usr/local/lib/node_modules/n8n/dist/services/frontend.service.js && \
    sed -i 's/workflowHistory: this\.license\.isWorkflowHistoryLicensed(),/workflowHistory: true,/g' /usr/local/lib/node_modules/n8n/dist/services/frontend.service.js && \
    sed -i 's/binaryDataS3: this\.license\.isBinaryDataS3Licensed(),/binaryDataS3: true,/g' /usr/local/lib/node_modules/n8n/dist/services/frontend.service.js && \
    sed -i 's/multipleMainInstances: this\.license\.isMultipleMainInstancesLicensed(),/multipleMainInstances: true,/g' /usr/local/lib/node_modules/n8n/dist/services/frontend.service.js && \
    sed -i 's/aiAssistant: this\.license\.isAiAssistantLicensed(),/aiAssistant: true,/g' /usr/local/lib/node_modules/n8n/dist/services/frontend.service.js && \
    sed -i 's/askAi: this\.license\.isAskAiLicensed(),/askAi: true,/g' /usr/local/lib/node_modules/n8n/dist/services/frontend.service.js && \
    sed -i 's/communityNodesCustomRegistry: this\.license\.isCommunityNodesCustomRegistryLicensed(),/communityNodesCustomRegistry: true,/g' /usr/local/lib/node_modules/n8n/dist/services/frontend.service.js && \
    sed -i 's/aiCredits: this\.license\.isAiCreditsLicensed(),/aiCredits: true,/g' /usr/local/lib/node_modules/n8n/dist/services/frontend.service.js && \
    sed -i 's/folders: this\.license\.isFoldersLicensed(),/folders: true,/g' /usr/local/lib/node_modules/n8n/dist/services/frontend.service.js && \
    sed -i 's/customRoles: this\.license\.isCustomRolesLicensed(),/customRoles: true,/g' /usr/local/lib/node_modules/n8n/dist/services/frontend.service.js && \
    sed -i 's/apiDisabled: this\.license\.isApiDisabledLicensed(),/apiDisabled: false,/g' /usr/local/lib/node_modules/n8n/dist/services/frontend.service.js && \
    sed -i 's/showNonProdBanner: this\.license\.isShowNonProdBannerLicensed(),/showNonProdBanner: false,/g' /usr/local/lib/node_modules/n8n/dist/services/frontend.service.js && \
    sed -i 's/projectRoleAdmin: this\.license\.isProjectRoleAdminLicensed(),/projectRoleAdmin: true,/g' /usr/local/lib/node_modules/n8n/dist/services/frontend.service.js && \
    sed -i 's/projectRoleEditor: this\.license\.isProjectRoleEditorLicensed(),/projectRoleEditor: true,/g' /usr/local/lib/node_modules/n8n/dist/services/frontend.service.js && \
    sed -i 's/projectRoleViewer: this\.license\.isProjectRoleViewerLicensed(),/projectRoleViewer: true,/g' /usr/local/lib/node_modules/n8n/dist/services/frontend.service.js && \
    sed -i 's/insightsViewSummary: this\.license\.isInsightsViewSummaryLicensed(),/insightsViewSummary: true,/g' /usr/local/lib/node_modules/n8n/dist/services/frontend.service.js && \
    sed -i 's/insightsViewDashboard: this\.license\.isInsightsViewDashboardLicensed(),/insightsViewDashboard: true,/g' /usr/local/lib/node_modules/n8n/dist/services/frontend.service.js && \
    sed -i 's/insightsViewHourlyData: this\.license\.isInsightsViewHourlyDataLicensed(),/insightsViewHourlyData: true,/g' /usr/local/lib/node_modules/n8n/dist/services/frontend.service.js

# Patch license.js to always return true for all license checks
RUN sed -i 's/return this\.manager\?\.hasFeatureEnabled(feature) \?\? false;/return true;/g' /usr/local/lib/node_modules/n8n/dist/license.js && \
    sed -i 's/isLicensed.*{.*return.*false.*}/isLicensed() { return true; }/g' /usr/local/lib/node_modules/n8n/dist/license.js && \
    sed -i 's/isSharingEnabled.*{.*return.*false.*}/isSharingEnabled() { return true; }/g' /usr/local/lib/node_modules/n8n/dist/license.js && \
    sed -i 's/isLogStreamingEnabled.*{.*return.*false.*}/isLogStreamingEnabled() { return true; }/g' /usr/local/lib/node_modules/n8n/dist/license.js && \
    sed -i 's/isLdapEnabled.*{.*return.*false.*}/isLdapEnabled() { return true; }/g' /usr/local/lib/node_modules/n8n/dist/license.js && \
    sed -i 's/isSamlEnabled.*{.*return.*false.*}/isSamlEnabled() { return true; }/g' /usr/local/lib/node_modules/n8n/dist/license.js && \
    sed -i 's/isOidcLicensed.*{.*return.*false.*}/isOidcLicensed() { return true; }/g' /usr/local/lib/node_modules/n8n/dist/license.js && \
    sed -i 's/isMFAEnforcementLicensed.*{.*return.*false.*}/isMFAEnforcementLicensed() { return true; }/g' /usr/local/lib/node_modules/n8n/dist/license.js && \
    sed -i 's/isAdvancedExecutionFiltersEnabled.*{.*return.*false.*}/isAdvancedExecutionFiltersEnabled() { return true; }/g' /usr/local/lib/node_modules/n8n/dist/license.js && \
    sed -i 's/isVariablesEnabled.*{.*return.*false.*}/isVariablesEnabled() { return true; }/g' /usr/local/lib/node_modules/n8n/dist/license.js && \
    sed -i 's/isSourceControlLicensed.*{.*return.*false.*}/isSourceControlLicensed() { return true; }/g' /usr/local/lib/node_modules/n8n/dist/license.js && \
    sed -i 's/isExternalSecretsEnabled.*{.*return.*false.*}/isExternalSecretsEnabled() { return true; }/g' /usr/local/lib/node_modules/n8n/dist/license.js && \
    sed -i 's/isDebugInEditorLicensed.*{.*return.*false.*}/isDebugInEditorLicensed() { return true; }/g' /usr/local/lib/node_modules/n8n/dist/license.js && \
    sed -i 's/isWorkerViewLicensed.*{.*return.*false.*}/isWorkerViewLicensed() { return true; }/g' /usr/local/lib/node_modules/n8n/dist/license.js && \
    sed -i 's/isAdvancedPermissionsLicensed.*{.*return.*false.*}/isAdvancedPermissionsLicensed() { return true; }/g' /usr/local/lib/node_modules/n8n/dist/license.js && \
    sed -i 's/isApiKeyScopesEnabled.*{.*return.*false.*}/isApiKeyScopesEnabled() { return true; }/g' /usr/local/lib/node_modules/n8n/dist/license.js && \
    sed -i 's/isWorkflowDiffsLicensed.*{.*return.*false.*}/isWorkflowDiffsLicensed() { return true; }/g' /usr/local/lib/node_modules/n8n/dist/license.js && \
    sed -i 's/isWorkflowHistoryLicensed.*{.*return.*false.*}/isWorkflowHistoryLicensed() { return true; }/g' /usr/local/lib/node_modules/n8n/dist/license.js && \
    sed -i 's/isBinaryDataS3Licensed.*{.*return.*false.*}/isBinaryDataS3Licensed() { return true; }/g' /usr/local/lib/node_modules/n8n/dist/license.js && \
    sed -i 's/isMultipleMainInstancesLicensed.*{.*return.*false.*}/isMultipleMainInstancesLicensed() { return true; }/g' /usr/local/lib/node_modules/n8n/dist/license.js && \
    sed -i 's/isAiAssistantLicensed.*{.*return.*false.*}/isAiAssistantLicensed() { return true; }/g' /usr/local/lib/node_modules/n8n/dist/license.js && \
    sed -i 's/isAskAiLicensed.*{.*return.*false.*}/isAskAiLicensed() { return true; }/g' /usr/local/lib/node_modules/n8n/dist/license.js && \
    sed -i 's/isCommunityNodesCustomRegistryLicensed.*{.*return.*false.*}/isCommunityNodesCustomRegistryLicensed() { return true; }/g' /usr/local/lib/node_modules/n8n/dist/license.js && \
    sed -i 's/isAiCreditsLicensed.*{.*return.*false.*}/isAiCreditsLicensed() { return true; }/g' /usr/local/lib/node_modules/n8n/dist/license.js && \
    sed -i 's/isFoldersLicensed.*{.*return.*false.*}/isFoldersLicensed() { return true; }/g' /usr/local/lib/node_modules/n8n/dist/license.js && \
    sed -i 's/isCustomRolesLicensed.*{.*return.*false.*}/isCustomRolesLicensed() { return true; }/g' /usr/local/lib/node_modules/n8n/dist/license.js && \
    sed -i 's/isApiDisabledLicensed.*{.*return.*false.*}/isApiDisabledLicensed() { return false; }/g' /usr/local/lib/node_modules/n8n/dist/license.js && \
    sed -i 's/isShowNonProdBannerLicensed.*{.*return.*false.*}/isShowNonProdBannerLicensed() { return false; }/g' /usr/local/lib/node_modules/n8n/dist/license.js && \
    sed -i 's/isProjectRoleAdminLicensed.*{.*return.*false.*}/isProjectRoleAdminLicensed() { return true; }/g' /usr/local/lib/node_modules/n8n/dist/license.js && \
    sed -i 's/isProjectRoleEditorLicensed.*{.*return.*false.*}/isProjectRoleEditorLicensed() { return true; }/g' /usr/local/lib/node_modules/n8n/dist/license.js && \
    sed -i 's/isProjectRoleViewerLicensed.*{.*return.*false.*}/isProjectRoleViewerLicensed() { return true; }/g' /usr/local/lib/node_modules/n8n/dist/license.js && \
    sed -i 's/isInsightsViewSummaryLicensed.*{.*return.*false.*}/isInsightsViewSummaryLicensed() { return true; }/g' /usr/local/lib/node_modules/n8n/dist/license.js && \
    sed -i 's/isInsightsViewDashboardLicensed.*{.*return.*false.*}/isInsightsViewDashboardLicensed() { return true; }/g' /usr/local/lib/node_modules/n8n/dist/license.js && \
    sed -i 's/isInsightsViewHourlyDataLicensed.*{.*return.*false.*}/isInsightsViewHourlyDataLicensed() { return true; }/g' /usr/local/lib/node_modules/n8n/dist/license.js

# Patch insights dashboard license checks
RUN find /usr/local/lib/node_modules/n8n/dist -name "*insights*" -type f | xargs grep -l "isInsightsDashboardLicensed\|isInsightsSummaryLicensed" | while read file; do \
        sed -i 's/isInsightsDashboardLicensed() { return.*}/isInsightsDashboardLicensed() { return true; }/g' "$file"; \
        sed -i 's/isInsightsSummaryLicensed() { return.*}/isInsightsSummaryLicensed() { return true; }/g' "$file"; \
        sed -i 's/this\.licenseState\.isInsightsDashboardLicensed()/true/g' "$file"; \
        sed -i 's/this\.licenseState\.isInsightsSummaryLicensed()/true/g' "$file"; \
    done || true

# Patch sharing service to always allow sharing
RUN find /usr/local/lib/node_modules/n8n/dist -name "*sharing*" -type f | while read file; do \
        sed -i 's/this\.license\.isSharingEnabled()/true/g' "$file"; \
        sed -i 's/this\.licenseState\.isSharingLicensed()/true/g' "$file"; \
    done || true

# Patch workflow sharing controller
RUN find /usr/local/lib/node_modules/n8n/dist -name "*workflow*" -type f | xargs grep -l "isSharingEnabled\|isSharingLicensed" | while read file; do \
        sed -i 's/this\.license\.isSharingEnabled()/true/g' "$file"; \
        sed -i 's/this\.licenseState\.isSharingLicensed()/true/g' "$file"; \
    done || true

# Completely disable source control in frontend to prevent connection errors
RUN find /usr/local/lib/node_modules/n8n/dist -name "*source-control*" -type f | while read file; do \
        sed -i 's/isSourceControlConnected()/false/g' "$file"; \
        sed -i 's/isSourceControlLicensedAndEnabled()/false/g' "$file"; \
        sed -i 's/source_control_not_connected/source_control_disabled/g' "$file"; \
    done || true

# Patch source control middleware to return success instead of error
RUN find /usr/local/lib/node_modules/n8n/dist -name "*middleware*" -type f | xargs grep -l "source_control" | while read file; do \
        sed -i 's/source_control_not_connected/source_control_disabled/g' "$file"; \
        sed -i 's/res\.status(412)/res.status(200)/g' "$file"; \
    done || true

# Patch frontend source control components to hide the feature entirely
RUN find /usr/local/lib/node_modules/n8n/dist -name "*frontend*" -type f | while read file; do \
        sed -i 's/isSourceControlEnabled()/false/g' "$file"; \
        sed -i 's/isSourceControlLicensed()/false/g' "$file"; \
    done || true

# Patch quota limits to be unlimited (-1)
RUN find /usr/local/lib/node_modules/n8n/dist -name "*license*" -type f | while read file; do \
        sed -i 's/getValue.*quota.*activeWorkflows.*/getValue(quota) { return -1; }/g' "$file"; \
        sed -i 's/getValue.*quota.*maxVariables.*/getValue(quota) { return -1; }/g' "$file"; \
        sed -i 's/getValue.*quota.*users.*/getValue(quota) { return -1; }/g' "$file"; \
        sed -i 's/getValue.*quota.*workflowHistoryPrune.*/getValue(quota) { return -1; }/g' "$file"; \
        sed -i 's/getValue.*quota.*maxTeamProjects.*/getValue(quota) { return -1; }/g' "$file"; \
        sed -i 's/getValue.*quota.*aiCredits.*/getValue(quota) { return -1; }/g' "$file"; \
        sed -i 's/getValue.*quota.*insights.*/getValue(quota) { return -1; }/g' "$file"; \
        sed -i 's/getValue.*quota.*evaluations.*/getValue(quota) { return -1; }/g' "$file"; \
    done || true

# Patch plan name to show Enterprise
RUN find /usr/local/lib/node_modules/n8n/dist -name "*license*" -type f | while read file; do \
        sed -i 's/getPlanName.*{.*return.*}/getPlanName() { return "Enterprise"; }/g' "$file"; \
        sed -i 's/getConsumerId.*{.*return.*}/getConsumerId() { return "enterprise-free"; }/g' "$file"; \
    done || true

# Set environment variables to disable license checks
ENV N8N_LICENSE_SERVER_URL=""
ENV N8N_LICENSE_SERVER_URL_TRIAL=""
ENV N8N_LICENSE_SERVER_URL_TRIAL_ACTIVATION=""
ENV N8N_LICENSE_SERVER_URL_TRIAL_ACTIVATION_RETRY=""

# Disable source control connection checks to prevent errors
ENV N8N_SOURCE_CONTROL_DISABLED="true"
ENV N8N_SOURCE_CONTROL_CONNECTED="false"

# Switch back to node user
USER node

# Expose port
EXPOSE 5678

# Keep the original entrypoint and cmd from the base image
ENTRYPOINT ["docker-entrypoint.sh"]
CMD ["n8n"]

